---
title: "How to use WeasyPrint in symfony 5 ?"
image: "/imgs/blog/weasyprint/cover.jpeg"
slug: weasyprint
---

<h2 class="article-title">How yo use WeasyPrint in Symfony 5?</h2>

## Introduction:

**WeasyPrint** is a smart solution helping web developers to create PDF documents. It turns simple HTML pages into gorgeous statistical reports, invoices, tickets…

WeasyPrint is based on Python, so you must have python installed in your server, and it's installed by default in most linux distributions.

You can read more about WeasyPrint [here!](https://doc.courtbouillon.org/weasyprint/stable/first_steps.html).

## Installation
You can install WeasyPrint by the python package manager `pip` or by `apt` the package manager of linux, you can see [here](https://doc.courtbouillon.org/weasyprint/stable/first_steps.html) form more options, for me I installed like this:
```bash
sudo apt-get update
sudo apt-get install libxml2-dev libxslt-dev libpango1.0-dev python3-pip build-essential python3-dev python3-pip python3-setuptools python3-wheel python3-cffi libcairo2 libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf2.0-0 libffi-dev shared-mime-info
sudo pip3 install WeasyPrint
sudo mv -fr ~/.local/bin/weasyprint /usr/bin
```
Now when you run the command `weasyprint --version` you should get something like this:

![WeasyPrint Version](imgs/blog/weasyprint/version.png)

You can install WeasyPrint also by
```bash
sudo apt-get install WeasyPrint
```
but the releases of Debian or Ubuntu often provide an old version of Cairo that may limit WeasyPrint’s features.

## Command-Line Usage
Using the WeasyPrint command line interface can be as simple as this:
```bash
weasyprint http://weasyprint.org /tmp/weasyprint-website.pdf
```

We will use this command in Symfony to generate the PDFs by using the `Process Component` of Symfony, the command will be similar to this:
```php
/** @var Symfony\Component\Process\Process $process*/
$process = new Process([$this->binary, $this->input, $this->output, '-o', '-f=pdf']);// weasyprint /tmp/randomfile /tmp/randomfile.pdf -o -f=pdf
$process->run();
```

the first file `/tmp/randomfile` is a temporary file created by php(see code bellow) contains the html code generated by the twig engine.
the second file `/tmp/randomfile.pdf` is also a temporary file contains the pdf that will rendred to the user.

## Usage in Symfony

In my Symfony project I always create a specific folder for services like this called `Infrastructure` in the `src` folder, so this is the structure of our Symfony project:
```
- bin
- config
- public
- src
    - Controller
    - Entity
    - Infrastructure
        - Pdf
            . PdfGeneratorInterface.php
            . WeasyPrintGenerator.php
    - Repository
- tests
- translations
...
```

The `PdfGeneratorInterface.php` contains one method that generate the pdf.
```php

declare(strict_types=1);

namespace App\Infrastructure\Pdf;

interface PdfGeneratorInerface
{
    /**
     * Generate a pdf from html.
     *
     * @return string the pdf content as string
     */
    public function getOutputFromHtml(string $html, string $header = null, string $footer = null): string;
}
```

The logic is in the `WeasyPrintGenerator.php` class that extends the interface and contains this code :
```php

declare(strict_types=1);

namespace App\Infrastructure\Pdf;

use Symfony\Component\Process\Exception\ProcessFailedException;
use Symfony\Component\Process\Process;

class WeasyPrintPdfGenerator implements PdfGeneratorInerface
{
    /**
     * Rendered Pdf file to the user.
     */
    private string $output;

    // file to write the html content
    private string $input;

    /**
     * Binary path of WeasyPrint.
     */
    private string $binary;

    public function __construct(string $binary)
    {
        $this->binary = $binary;
    }

    public function getOutputFromHtml(string $html, string $header = null, string $footer = null): string
    {
        $inputFile = tmpfile(); // Creates a temporary file

        $input = stream_get_meta_data($inputFile)['uri']; // uri (string) - the URI/filename associated with this stream.

        if ($header) {
            file_put_contents($input, $header, LOCK_EX);
        }

        // using the FILE_APPEND flag to append the content to the end of the file
        // and the LOCK_EX flag to prevent anyone else writing to the file at the same time
        file_put_contents($input, $html, FILE_APPEND | LOCK_EX);

        if ($footer) {
            file_put_contents($input, $footer, FILE_APPEND | LOCK_EX);
        }

        $this->input = $input;// Ex: /tmp/randomfile random file created by PHP

        $this->output = $input.'pdf'; // Ex: /tmp/randomfile.pdf the pdf file that will be rendered to the user

        $process = new Process([$this->binary, $this->input, $this->output, '-o', '-f=pdf']); // Ex: weasyprint /tmp/randomfile /tmp/randomfile.pdf -o -f=pdf
        $process->setTimeout(50);
        $process->run();

        // executes after the command finishes
        if (!$process->isSuccessful()) {
            throw new ProcessFailedException($process);
        }

        return $this->output;
    }
}
```
The variable *$binary* is the path of the WeasyPrint binary.

```js
#.env
WEASYPRINT_PATH=weasyprint
```

Don't forget to tell service container about the binary path in `services.yaml` file.

```yaml
#config/services.yaml
services:

    ...

    App\Infrastructure\Pdf\WeasyPrintPdfGenerator:
      arguments:
        $binary: '%env(WEASYPRINT_PATH)%'
```


Now in your app inject the `PdfGeneratorInterface` and generate your pdf as in the following example:
```php

declare(strict_types=1);

namespace App\Service;

use App\Infrastructure\Pdf\PdfGeneratorInerface;
use Symfony\Component\HttpFoundation\BinaryFileResponse;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpFoundation\ResponseHeaderBag;
use Symfony\Component\Mime\FileinfoMimeTypeGuesser;
use Twig\Environment;

class PdfService
{
    private Environment $twig;
    private PdfGeneratorInerface $pdfGenerator;

    public function __construct(Environment $twig, PdfGeneratorInerface $pdfGenerator)
    {
        $this->twig = $twig;
        $this->pdfGenerator = $pdfGenerator;
    }

    public function pdf(Product $product): Response
    {
        $header = $this->twig->render('pdf/pdf_headers.html.twig');

        $html = $this->twig->render('pdf/body.html.twig', [
            'product' => $product,
        ]);

        $title = 'PDF Title';

        $filename = "{$title}.pdf";

        $content = $this->pdfGenerator->getOutputFromHtml($html, $header);

        return $this->fileResponse($content, $filename);
    }

    private function fileResponse(string $content, string $filename = 'file.pdf'): Response
    {
        $response = new BinaryFileResponse($content);
        // To generate a file download, you need the mimetype of the file
        $mimeTypeGuesser = new FileinfoMimeTypeGuesser();

        // Set the mimetype with the guesser or manually
        if ($mimeTypeGuesser->isGuesserSupported()) {
            // Guess the mimetype of the file according to the extension of the file
            $response->headers->set('Content-Type', $mimeTypeGuesser->guessMimeType($content));
        } else {
            // Set the mimetype of the file manually, in this case for a pdf file is application/pdf
            $response->headers->set('Content-Type', 'application/pdf');
        }

        // Set content disposition inline of the file
        $response->setContentDisposition(ResponseHeaderBag::DISPOSITION_INLINE, $filename);

        $response->deleteFileAfterSend(true); // Delete the file after showing it to the user.

        return $response;
    }
```

Now in your controller:

```php

declare(strict_types=1);

namespace App\Controller;

use App\Entity\Product;
use App\Service\PdfService;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;

class ProductController extends AbstractController
{
    /**
     * @Route("/products/{id}/pdf", name="products_pdf", methods={"GET"})
     */
     public function pdf(Product $product, PdfService $pdfService): Response
     {
        return $pdfService->pdf($product);
     }
}
```

So now you can generate the awesome PDFs by using this beautifull python library in the next projects.

 ___

Author: **Imad NAJMI**
